# å¢å¼ºç‰ˆ Makefile - æ·»åŠ å®‰å…¨éƒ¨ç½²æµç¨‹
# å°†æ­¤å†…å®¹æ·»åŠ åˆ°ç°æœ‰Makefileä¸­

# å®‰å…¨éƒ¨ç½² - åŒ…å«é¢„æ£€æŸ¥å’Œç¡®è®¤
safe-deploy: pre-deploy-check build-layers-optimized package-lambdas package-infrastructure-lambdas tf-plan-confirm tf-apply post-deploy-verify
	@echo "âœ… å®‰å…¨éƒ¨ç½²å·²å®Œæˆå¹¶éªŒè¯æˆåŠŸ"

# é¢„éƒ¨ç½²æ£€æŸ¥
pre-deploy-check:
	@echo "ğŸ” è¿è¡Œé¢„éƒ¨ç½²å¥åº·æ£€æŸ¥..."
	@python3 scripts/pre_deploy_health_check.py || (echo "âŒ é¢„æ£€æŸ¥å¤±è´¥ï¼Œè¯·ä¿®å¤é—®é¢˜åé‡è¯•" && exit 1)
	@echo "âœ… é¢„æ£€æŸ¥é€šè¿‡"

# æ˜¾ç¤ºå˜æ›´è®¡åˆ’å¹¶è¯·æ±‚ç¡®è®¤
tf-plan-confirm:
	@echo "ğŸ“‹ æ˜¾ç¤ºTerraformå˜æ›´è®¡åˆ’..."
	@cd infrastructure && terraform plan -var="project_name=$(PROJECT_NAME)" -var="aws_region=$(AWS_REGION)"
	@echo "âš ï¸  è¯·ä»”ç»†æ£€æŸ¥ä¸Šè¿°å˜æ›´è®¡åˆ’"
	@read -p "æ˜¯å¦ç»§ç»­éƒ¨ç½²? (y/N): " confirm && [ "$$confirm" = "y" ] || (echo "éƒ¨ç½²å·²å–æ¶ˆ" && exit 1)

# éƒ¨ç½²åéªŒè¯
post-deploy-verify:
	@echo "ğŸ§ª è¿è¡Œéƒ¨ç½²åéªŒè¯æµ‹è¯•..."
	@sleep 10  # ç­‰å¾…èµ„æºåˆå§‹åŒ–
	@python3 comprehensive_api_test.py || echo "âš ï¸ éƒ¨ç½²åæµ‹è¯•å‘ç°é—®é¢˜ï¼Œè¯·æ£€æŸ¥"
	@echo "âœ… éƒ¨ç½²éªŒè¯å®Œæˆ"

# å¿«é€Ÿéƒ¨ç½² (ä¿æŒåŸæœ‰è¡Œä¸º)
quick-deploy: deploy
	@echo "âš¡ å¿«é€Ÿéƒ¨ç½²å®Œæˆ (è·³è¿‡äº†å®‰å…¨æ£€æŸ¥)"