# 增强版 Makefile - 添加安全部署流程
# 将此内容添加到现有Makefile中

# 安全部署 - 包含预检查和确认
safe-deploy: pre-deploy-check build-layers-optimized package-lambdas package-infrastructure-lambdas tf-plan-confirm tf-apply post-deploy-verify
	@echo "✅ 安全部署已完成并验证成功"

# 预部署检查
pre-deploy-check:
	@echo "🔍 运行预部署健康检查..."
	@python3 scripts/pre_deploy_health_check.py || (echo "❌ 预检查失败，请修复问题后重试" && exit 1)
	@echo "✅ 预检查通过"

# 显示变更计划并请求确认
tf-plan-confirm:
	@echo "📋 显示Terraform变更计划..."
	@cd infrastructure && terraform plan -var="project_name=$(PROJECT_NAME)" -var="aws_region=$(AWS_REGION)"
	@echo "⚠️  请仔细检查上述变更计划"
	@read -p "是否继续部署? (y/N): " confirm && [ "$$confirm" = "y" ] || (echo "部署已取消" && exit 1)

# 部署后验证
post-deploy-verify:
	@echo "🧪 运行部署后验证测试..."
	@sleep 10  # 等待资源初始化
	@python3 comprehensive_api_test.py || echo "⚠️ 部署后测试发现问题，请检查"
	@echo "✅ 部署验证完成"

# 快速部署 (保持原有行为)
quick-deploy: deploy
	@echo "⚡ 快速部署完成 (跳过了安全检查)"