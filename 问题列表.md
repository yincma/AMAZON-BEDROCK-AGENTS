# AI PPT Assistant 部署问题列表

## 部署时间
- 日期：2025-09-12
- 部署命令：`make deploy-reliable`
- 总耗时：约 7 分钟

## 问题分类

### 1. 🔧 环境和依赖问题

#### 1.1 Python 版本不匹配
- **问题描述**：本地使用 Python 3.13，但 Lambda 运行时是 3.12
- **影响**：可能导致兼容性问题
- **当前状态**：⚠️ 警告但可运行
- **建议解决方案**：
  - 使用 Docker 构建 Lambda 层以确保版本一致
  - 或者本地安装 Python 3.12 进行开发

#### 1.2 Lambda 层大小超标
- **问题描述**：
  - Minimal 层：15MB（目标 10MB）
  - Content 层：27MB（目标 25MB）
- **影响**：增加冷启动时间，但在 AWS 限制内
- **当前状态**：⚠️ 警告但可运行
- **建议解决方案**：
  - 审查依赖，移除不必要的包
  - 考虑分层策略优化

#### 1.3 pip 依赖冲突
- **问题描述**：`pip's dependency resolver does not currently take into account all the packages that are installed`
- **影响**：可能导致包版本冲突
- **当前状态**：⚠️ 警告但可运行
- **建议解决方案**：使用虚拟环境隔离依赖

#### 1.4 aws-lambda-powertools 警告
- **问题描述**：`aws-lambda-powertools 2.38.0 does not provide the extra 'logger'`
- **影响**：某些日志功能可能不可用
- **当前状态**：⚠️ 警告但可运行
- **建议解决方案**：检查 requirements.txt 中的包声明格式

### 2. 🏗️ Terraform 和基础设施问题

#### 2.1 Bedrock Agent Alias ID 传递问题
- **问题描述**：Terraform 创建的 Bedrock Agent Alias ID 没有正确传递到 Lambda 函数环境变量
- **根本原因**：
  1. Terraform 模块输出格式问题（使用了 `.id` 而不是 `.agent_alias_id`）
  2. null_resource 执行时机问题
  3. Lambda 函数名格式不一致（下划线 vs 横线）
- **影响**：Lambda 函数无法调用 Bedrock Agents
- **当前状态**：✅ 已修复
- **修复方案**：
  ```hcl
  # infrastructure/modules/bedrock/main.tf
  output "agent_alias_ids" {
    value = {
      orchestrator = aws_bedrockagent_agent_alias.orchestrator.agent_alias_id
      # 而不是 .id
    }
  }
  ```

#### 2.2 Lambda 函数名引用错误
- **问题描述**：null_resource 中使用了错误的函数名格式（`create_outline` vs `create-outline`）
- **影响**：控制器函数的环境变量更新失败
- **当前状态**：✅ 已通过后续脚本修复
- **建议解决方案**：统一函数命名规范

### 3. 🔄 配置同步问题

#### 3.1 sync_bedrock_config.sh 脚本缺失
- **问题描述**：初始部署时脚本不存在
- **影响**：无法自动同步 Bedrock 配置
- **当前状态**：✅ 已创建脚本
- **脚本功能**：
  - 获取 Bedrock Agent IDs 和 Alias IDs
  - 批量更新所有 Lambda 函数环境变量

#### 3.2 配置同步时机问题
- **问题描述**：配置同步执行太晚或太早
- **影响**：Lambda 函数可能使用过时的配置
- **当前状态**：✅ 已在 Makefile 中添加等待时间
- **解决方案**：
  ```makefile
  # 等待资源初始化
  @sleep 20
  # 同步配置
  ./scripts/sync_bedrock_config.sh
  # 等待更新生效
  @sleep 10
  ```

### 4. 📊 验证和测试问题

#### 4.1 部署验证脚本检测问题
- **问题描述**：验证脚本检测到 ORCHESTRATOR_ALIAS_ID 为 "None"
- **影响**：无法确认部署是否成功
- **当前状态**：✅ 已修复
- **解决方案**：手动运行配置同步脚本

#### 4.2 API 请求格式问题
- **问题描述**：创建演示文稿 API 返回 "Invalid request body"
- **可能原因**：
  - API Gateway 请求验证器配置
  - Lambda 函数期望的请求格式不明确
- **当前状态**：⚠️ 需要进一步调查
- **建议解决方案**：
  - 检查 API Gateway 的请求模型定义
  - 查看 Lambda 函数代码确认期望的输入格式

#### 4.3 CloudWatch 日志组不存在
- **问题描述**：尝试查看日志时发现日志组不存在
- **可能原因**：Lambda 函数尚未执行过
- **当前状态**：ℹ️ 正常行为
- **解决方案**：首次调用后会自动创建

### 5. 🎨 用户体验问题

#### 5.1 部署输出过于冗长
- **问题描述**：Terraform apply 输出大量详细信息，难以追踪关键进度
- **影响**：用户难以了解部署状态
- **当前状态**：✅ 已优化
- **解决方案**：使用 grep 过滤只显示关键信息
  ```bash
  terraform apply 2>&1 | grep -E "(Apply complete|Creating.*bedrock|Error:|failed)"
  ```

### 6. 🔍 发现的架构问题

#### 6.1 sync_bedrock_config.sh 脚本重复问题
- **问题描述**：存在两个版本的 sync_bedrock_config.sh 脚本
  - `scripts/sync_bedrock_config.sh` (7948 bytes，主版本)
  - `infrastructure/scripts/sync_bedrock_config.sh` (4996 bytes，旧版本)
- **根本原因**：
  - 开发过程中在不同位置创建了脚本
  - 两个版本内容不一致导致混淆
  - Makefile 引用的是 `scripts/` 下的版本
- **影响**：可能导致混淆，不知道哪个是正确版本
- **当前状态**：✅ 已修复
- **解决方案**：
  - 删除了 `infrastructure/scripts/` 下的重复版本
  - 保留 `scripts/` 下的主版本
  - 确保脚本已加入版本控制

#### 6.2 DynamoDB 表使用不一致
- **问题描述**：不同 Lambda 函数使用不同的 DynamoDB 表（sessions vs tasks）
- **影响**：可能导致数据查询失败
- **当前状态**：⚠️ 需要统一
- **建议解决方案**：
  - 明确各表的用途
  - 统一环境变量命名

#### 6.3 多个后台任务同时运行
- **问题描述**：系统提示有多个 Terraform apply 和测试脚本在后台运行
- **影响**：可能导致资源冲突
- **当前状态**：ℹ️ 需要注意
- **建议解决方案**：确保一次只运行一个部署任务

## 总结

### ✅ 已解决的问题（8个）
1. Bedrock Agent Alias ID 传递问题
2. sync_bedrock_config.sh 脚本创建
3. 配置同步时机优化
4. 部署验证问题
5. 部署输出优化
6. Lambda 函数环境变量更新
7. Makefile deploy-reliable 目标优化
8. sync_bedrock_config.sh 脚本重复问题

### ⚠️ 警告但不影响运行（5个）
1. Python 版本不匹配（3.13 vs 3.12）
2. Lambda 层大小超标
3. pip 依赖冲突
4. aws-lambda-powertools 警告
5. DynamoDB 表使用不一致

### ❓ 需要进一步调查（2个）
1. API 创建演示文稿的请求格式
2. Lambda 函数的具体输入输出格式

## 改进建议

### 短期改进
1. 创建 API 文档，明确请求/响应格式
2. 添加更详细的错误日志
3. 统一 Lambda 函数命名规范

### 长期改进
1. 使用 Docker 构建确保环境一致性
2. 实现 CI/CD 自动化部署
3. 添加集成测试套件
4. 优化 Lambda 层依赖管理
5. 实现配置中心统一管理

## 部署成功信息

尽管存在上述问题，系统最终成功部署：
- **API Gateway ID**: 8a8sz6kor5
- **API Key**: 4GmC6GUjsD22z00PTsoQq4V3L113Xefw9ztNascQ
- **Bedrock Agents**: 全部创建成功（4个）
- **DynamoDB 表**: 全部就绪（3个）
- **Lambda 函数**: 全部部署（20个）
- **总资源数**: 254个

---
*生成时间: 2025-09-12 19:43*