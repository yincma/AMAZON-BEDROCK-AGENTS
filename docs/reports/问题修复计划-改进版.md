# AI PPT Assistant é—®é¢˜ä¿®å¤è®¡åˆ’ - æ”¹è¿›ç‰ˆ

**æ–‡æ¡£ç‰ˆæœ¬**: 2.0  
**åˆ›å»ºæ—¶é—´**: 2025-09-11  
**è´Ÿè´£äºº**: AWSä¸“å®¶å›¢é˜Ÿ  
**ç³»ç»Ÿç‰ˆæœ¬**: ai-ppt-assistant-dev  
**éƒ¨ç½²åŒºåŸŸ**: us-east-1  

## æ‰§è¡Œæ‘˜è¦

åŸºäºŽGè€å¸ˆçš„ä¸“ä¸šå»ºè®®ï¼Œæœ¬æ”¹è¿›ç‰ˆä¿®å¤è®¡åˆ’ä¸ä»…è§£å†³å½“å‰çš„18ä¸ªæŠ€æœ¯é—®é¢˜ï¼Œæ›´é‡è¦çš„æ˜¯å»ºç«‹**é•¿æœŸç¨³æ€**çš„è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡é…ç½®ä¸­å¿ƒåŒ–ã€å•ä¸€çœŸç›¸æºã€IaCç®¡æŽ§ç­‰æŽªæ–½ï¼Œå½»åº•é¿å…é…ç½®æ¼‚ç§»å’ŒçŽ¯å¢ƒä¸ä¸€è‡´é—®é¢˜ã€‚

**å…³é”®æ”¹è¿›**:
- ðŸ” ç«‹å³è½®æ¢å·²æ³„éœ²çš„APIå¯†é’¥
- ðŸ·ï¸ ä½¿ç”¨Agentåˆ«åæ›¿ä»£ç¡¬ç¼–ç ID
- ðŸŽ¯ ç»Ÿä¸€åˆ°å•ä¸€API Gatewayå’ŒStage
- ðŸ’¾ å®žæ–½DynamoDBæ•°æ®è¿ç§»
- ðŸ”§ é…ç½®ä¸­å¿ƒåŒ–(SSM Parameter Store)
- ðŸš€ CI/CDè‡ªåŠ¨éªŒè¯é—¸

**é¢„è®¡ä¿®å¤æ—¶é—´**: 
- P0çº§é—®é¢˜(å«å®‰å…¨): 1-2å°æ—¶ï¼ˆç«‹å³æ‰§è¡Œï¼‰
- P1çº§é—®é¢˜: 4-6å°æ—¶  
- é•¿æœŸåŒ–æ”¹é€ : 1-2å¤©
- ç›‘æŽ§ä¼˜åŒ–: æŒç»­è¿­ä»£

---

## ç¬¬é›¶é˜¶æ®µï¼šç´§æ€¥å®‰å…¨æŽªæ–½ï¼ˆç«‹å³æ‰§è¡Œï¼‰

### 0.1 APIå¯†é’¥è½®æ¢ ðŸ”´ æœ€é«˜ä¼˜å…ˆçº§

**é—®é¢˜**: æ–‡æ¡£ä¸­å·²æ³„éœ²API Keyï¼ˆ9EQHqfmiuA5GrkMnK5PVf8OpbIcsMj1N2z6PFGR3ï¼‰

**ç«‹å³æ‰§è¡Œ**:
```bash
# æ­¥éª¤1: åˆ›å»ºæ–°çš„APIå¯†é’¥
NEW_API_KEY=$(aws apigateway create-api-key \
  --name ai-ppt-assistant-dev-key-$(date +%Y%m%d) \
  --enabled \
  --query 'value' \
  --output text \
  --region us-east-1)

echo "æ–°APIå¯†é’¥å·²åˆ›å»ºï¼ˆè¯·ç«‹å³ä¿å­˜åˆ°å®‰å…¨ä½ç½®ï¼‰: $NEW_API_KEY"

# æ­¥éª¤2: å…³è”åˆ°ä½¿ç”¨è®¡åˆ’
USAGE_PLAN_ID=$(aws apigateway get-usage-plans \
  --query 'items[?name==`ai-ppt-assistant-usage-plan`].id' \
  --output text \
  --region us-east-1)

aws apigateway create-usage-plan-key \
  --usage-plan-id $USAGE_PLAN_ID \
  --key-id $(aws apigateway get-api-keys --query "items[?value=='$NEW_API_KEY'].id" --output text) \
  --key-type API_KEY \
  --region us-east-1

# æ­¥éª¤3: å­˜å‚¨åˆ°SSM Parameter Storeï¼ˆåŠ å¯†ï¼‰
aws ssm put-parameter \
  --name "/ai-ppt-assistant/dev/api-key" \
  --value "$NEW_API_KEY" \
  --type "SecureString" \
  --overwrite \
  --region us-east-1

# æ­¥éª¤4: ç¦ç”¨æ—§å¯†é’¥
OLD_KEY_ID=$(aws apigateway get-api-keys \
  --query "items[?value=='9EQHqfmiuA5GrkMnK5PVf8OpbIcsMj1N2z6PFGR3'].id" \
  --output text \
  --region us-east-1)

if [ ! -z "$OLD_KEY_ID" ]; then
  aws apigateway update-api-key \
    --api-key $OLD_KEY_ID \
    --patch-operations op=replace,path=/enabled,value=false \
    --region us-east-1
  echo "æ—§å¯†é’¥å·²ç¦ç”¨"
fi
```

### 0.2 æ¸…ç†ä»“åº“ä¸­çš„æ•æ„Ÿä¿¡æ¯

```bash
# åˆ›å»ºå®‰å…¨çš„é…ç½®æ¨¡æ¿
cat > api_config_info.json << 'EOF'
{
  "project": "ai-ppt-assistant",
  "environment": "dev",
  "region": "us-east-1",
  "api_gateway_url": "{{API_GATEWAY_URL}}",
  "api_key_parameter": "/ai-ppt-assistant/dev/api-key",
  "note": "Actual values are stored in AWS SSM Parameter Store",
  "updated_at": "2025-09-11T19:00:00Z",
  "updated_by": "security_fix"
}
EOF

# æ¸…ç†GitåŽ†å²ï¼ˆå¦‚æžœéœ€è¦ï¼‰
# git filter-branch --force --index-filter \
#   'git rm --cached --ignore-unmatch api_config_info.json' \
#   --prune-empty --tag-name-filter cat -- --all
```

---

## ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½æ¢å¤ï¼ˆP0çº§ï¼‰

### 1.1 Bedrock Agenté…ç½® - ä½¿ç”¨åˆ«åæ›¿ä»£ç¡¬ç¼–ç ID

**å…³é”®æ”¹è¿›**: ä¸ºæ‰€æœ‰Agentåˆ›å»ºç»Ÿä¸€åˆ«åï¼Œé¿å…IDå˜åŒ–å¸¦æ¥çš„è¿žé”ä¿®æ”¹

```python
#!/usr/bin/env python3
# fix_agent_config.py
import boto3
import json
from datetime import datetime

# åˆå§‹åŒ–å®¢æˆ·ç«¯
bedrock = boto3.client('bedrock-agent', region_name='us-east-1')
lambda_client = boto3.client('lambda', region_name='us-east-1')
ssm = boto3.client('ssm', region_name='us-east-1')

def create_or_update_agent_alias(agent_id, alias_name='dev'):
    """ä¸ºAgentåˆ›å»ºæˆ–æ›´æ–°åˆ«å"""
    try:
        # æ£€æŸ¥åˆ«åæ˜¯å¦å­˜åœ¨
        response = bedrock.list_agent_aliases(agentId=agent_id)
        existing_alias = next((a for a in response['agentAliasSummaries'] 
                              if a['aliasName'] == alias_name), None)
        
        if existing_alias:
            print(f"âœ“ åˆ«å {alias_name} å·²å­˜åœ¨äºŽAgent {agent_id}")
            return existing_alias['agentAliasId']
        else:
            # åˆ›å»ºæ–°åˆ«å
            response = bedrock.create_agent_alias(
                agentId=agent_id,
                agentAliasName=alias_name,
                description=f"Development alias created at {datetime.now()}"
            )
            print(f"âœ… åˆ›å»ºåˆ«å {alias_name} æˆåŠŸ: {response['agentAlias']['agentAliasId']}")
            return response['agentAlias']['agentAliasId']
    except Exception as e:
        print(f"âš ï¸ å¤„ç†Agent {agent_id} æ—¶å‡ºé”™: {e}")
        return None

def store_config_in_ssm():
    """å°†é…ç½®å­˜å‚¨åˆ°SSM Parameter Store"""
    
    # Agenté…ç½®æ˜ å°„ï¼ˆä½¿ç”¨åˆ«åè€ŒéžIDï¼‰
    agent_configs = {
        'orchestrator': {
            'agent_id': 'Q6RODNGFYR',
            'alias_name': 'dev',
            'functions': ['ai-ppt-assistant-api-generate-presentation']
        },
        'content': {
            'agent_id': 'L0ZQHJSU4X',
            'alias_name': 'dev',
            'functions': ['ai-ppt-assistant-generate-content']
        },
        'visual': {
            'agent_id': 'FO53FNXIRL',
            'alias_name': 'dev',
            'functions': ['ai-ppt-assistant-generate-image']
        },
        'compiler': {
            'agent_id': 'B02XIGCUKI',
            'alias_name': 'dev',
            'functions': ['ai-ppt-assistant-compile-pptx']
        }
    }
    
    # ä¸ºæ¯ä¸ªAgentåˆ›å»ºåˆ«åå¹¶å­˜å‚¨é…ç½®
    for agent_type, config in agent_configs.items():
        agent_id = config['agent_id']
        alias_name = config['alias_name']
        
        # åˆ›å»ºæˆ–èŽ·å–åˆ«åID
        alias_id = create_or_update_agent_alias(agent_id, alias_name)
        
        if alias_id:
            # å­˜å‚¨åˆ°SSM
            param_prefix = f"/ai-ppt-assistant/dev/agents/{agent_type}"
            
            # å­˜å‚¨Agent ID
            ssm.put_parameter(
                Name=f"{param_prefix}/id",
                Value=agent_id,
                Type="String",
                Overwrite=True
            )
            
            # å­˜å‚¨åˆ«åID
            ssm.put_parameter(
                Name=f"{param_prefix}/alias_id",
                Value=alias_id,
                Type="String",
                Overwrite=True
            )
            
            # å­˜å‚¨åˆ«ååç§°ï¼ˆä¾›ä»£ç å¼•ç”¨ï¼‰
            ssm.put_parameter(
                Name=f"{param_prefix}/alias_name",
                Value=alias_name,
                Type="String",
                Overwrite=True
            )
            
            print(f"âœ… {agent_type} Agenté…ç½®å·²å­˜å‚¨åˆ°SSM")
            
            # æ›´æ–°Lambdaå‡½æ•°çŽ¯å¢ƒå˜é‡ï¼ˆå¼•ç”¨SSMå‚æ•°ï¼‰
            for func_name in config['functions']:
                try:
                    # èŽ·å–å½“å‰é…ç½®
                    response = lambda_client.get_function_configuration(
                        FunctionName=func_name
                    )
                    
                    # æ›´æ–°çŽ¯å¢ƒå˜é‡
                    env_vars = response.get('Environment', {}).get('Variables', {})
                    env_vars.update({
                        f'{agent_type.upper()}_AGENT_ALIAS': alias_name,
                        f'{agent_type.upper()}_AGENT_ALIAS_ID': alias_id,
                        'CONFIG_SOURCE': 'SSM_PARAMETER_STORE'
                    })
                    
                    lambda_client.update_function_configuration(
                        FunctionName=func_name,
                        Environment={'Variables': env_vars}
                    )
                    
                    print(f"âœ… æ›´æ–°Lambdaå‡½æ•° {func_name} çŽ¯å¢ƒå˜é‡")
                    
                except Exception as e:
                    print(f"âŒ æ›´æ–°å‡½æ•° {func_name} å¤±è´¥: {e}")

if __name__ == "__main__":
    print("ðŸš€ å¼€å§‹ä¿®å¤Agenté…ç½®...")
    store_config_in_ssm()
    print("âœ¨ Agenté…ç½®ä¿®å¤å®Œæˆ")
```

### 1.2 ç»Ÿä¸€API Gatewayå’ŒStage

**å…³é”®æ”¹è¿›**: åªä¿ç•™ä¸€ä¸ªAPIå’Œä¸€ä¸ªStageï¼Œåˆ é™¤å†—ä½™èµ„æº

```bash
#!/bin/bash
# unify_api_gateway.sh

echo "ðŸ” æ£€æŸ¥çŽ°æœ‰API Gateway..."

# èŽ·å–æ‰€æœ‰API
aws apigateway get-rest-apis --region us-east-1 --query 'items[*].[id,name]' --output table

# ç¡®å®šè¦ä¿ç•™çš„APIï¼ˆä½¿ç”¨æœ€æ´»è·ƒçš„ï¼‰
PRIMARY_API_ID="otmr3noxg5"  # æ ¹æ®å®žé™…æƒ…å†µé€‰æ‹©
PRIMARY_STAGE="dev"

echo "âœ… å°†ç»Ÿä¸€ä½¿ç”¨API: $PRIMARY_API_ID, Stage: $PRIMARY_STAGE"

# æ­¥éª¤1: åˆ é™¤legacy stage
aws apigateway delete-stage \
  --rest-api-id $PRIMARY_API_ID \
  --stage-name legacy \
  --region us-east-1 2>/dev/null || echo "legacy stageä¸å­˜åœ¨æˆ–å·²åˆ é™¤"

# æ­¥éª¤2: ç¡®ä¿dev stageå­˜åœ¨å¹¶æ›´æ–°
aws apigateway create-deployment \
  --rest-api-id $PRIMARY_API_ID \
  --stage-name $PRIMARY_STAGE \
  --description "Unified deployment $(date +%Y%m%d-%H%M%S)" \
  --region us-east-1

# æ­¥éª¤3: æ›´æ–°ä½¿ç”¨è®¡åˆ’ - æ¸…ç©ºåŽé‡æ–°æ·»åŠ 
USAGE_PLAN_ID=$(aws apigateway get-usage-plans \
  --query 'items[0].id' \
  --output text \
  --region us-east-1)

# ç§»é™¤æ‰€æœ‰çŽ°æœ‰stageå…³è”
EXISTING_STAGES=$(aws apigateway get-usage-plan \
  --usage-plan-id $USAGE_PLAN_ID \
  --query 'apiStages[*].[apiId,stage]' \
  --output text \
  --region us-east-1)

while IFS=$'\t' read -r api_id stage_name; do
  if [ ! -z "$api_id" ]; then
    aws apigateway update-usage-plan \
      --usage-plan-id $USAGE_PLAN_ID \
      --patch-operations op=remove,path="/apiStages/${api_id}:${stage_name}" \
      --region us-east-1 2>/dev/null || true
  fi
done <<< "$EXISTING_STAGES"

# æ·»åŠ å”¯ä¸€çš„stageå…³è”
aws apigateway update-usage-plan \
  --usage-plan-id $USAGE_PLAN_ID \
  --patch-operations op=add,path=/apiStages,value="${PRIMARY_API_ID}:${PRIMARY_STAGE}" \
  --region us-east-1

# æ­¥éª¤4: å­˜å‚¨åˆ°SSM
aws ssm put-parameter \
  --name "/ai-ppt-assistant/dev/api-gateway-url" \
  --value "https://${PRIMARY_API_ID}.execute-api.us-east-1.amazonaws.com/${PRIMARY_STAGE}" \
  --type "String" \
  --overwrite \
  --region us-east-1

echo "âœ… API Gatewayç»Ÿä¸€å®Œæˆ"

# æ­¥éª¤5: åˆ é™¤å…¶ä»–æœªä½¿ç”¨çš„APIï¼ˆè°¨æ…Žæ“ä½œï¼‰
# aws apigateway get-rest-apis --query 'items[?id!=`'$PRIMARY_API_ID'`].id' --output text | \
#   xargs -I {} aws apigateway delete-rest-api --rest-api-id {} --region us-east-1
```

### 1.3 DynamoDBè¡¨ç»Ÿä¸€å’Œæ•°æ®è¿ç§»

**å…³é”®æ”¹è¿›**: åŒ…å«æ•°æ®è¿ç§»è„šæœ¬ï¼Œç¡®ä¿æ— æ•°æ®ä¸¢å¤±

```python
#!/usr/bin/env python3
# migrate_dynamodb_data.py
import boto3
from datetime import datetime
import json

dynamodb = boto3.resource('dynamodb', region_name='us-east-1')
lambda_client = boto3.client('lambda', region_name='us-east-1')
ssm = boto3.client('ssm', region_name='us-east-1')

def migrate_data():
    """è¿ç§»tasksè¡¨æ•°æ®åˆ°sessionsè¡¨"""
    
    # å®šä¹‰è¡¨
    tasks_table = dynamodb.Table('ai-ppt-assistant-dev-tasks')
    sessions_table = dynamodb.Table('ai-ppt-assistant-dev-sessions')
    
    print("ðŸ“Š å¼€å§‹æ•°æ®è¿ç§»...")
    
    # æ­¥éª¤1: å¤‡ä»½çŽ°æœ‰æ•°æ®
    backup_data = {
        'tasks': [],
        'sessions': [],
        'backup_time': datetime.now().isoformat()
    }
    
    # æ‰«ætasksè¡¨
    try:
        response = tasks_table.scan()
        backup_data['tasks'] = response.get('Items', [])
        print(f"âœ“ ä»Žtasksè¡¨è¯»å– {len(backup_data['tasks'])} æ¡è®°å½•")
    except Exception as e:
        print(f"âš ï¸ è¯»å–tasksè¡¨å¤±è´¥: {e}")
    
    # æ‰«æsessionsè¡¨
    try:
        response = sessions_table.scan()
        backup_data['sessions'] = response.get('Items', [])
        print(f"âœ“ ä»Žsessionsè¡¨è¯»å– {len(backup_data['sessions'])} æ¡è®°å½•")
    except Exception as e:
        print(f"âš ï¸ è¯»å–sessionsè¡¨å¤±è´¥: {e}")
    
    # ä¿å­˜å¤‡ä»½
    with open(f'dynamodb_backup_{datetime.now().strftime("%Y%m%d_%H%M%S")}.json', 'w') as f:
        json.dump(backup_data, f, indent=2, default=str)
    print("âœ… æ•°æ®å¤‡ä»½å®Œæˆ")
    
    # æ­¥éª¤2: è¿ç§»æ•°æ®
    migrated_count = 0
    failed_count = 0
    
    for item in backup_data['tasks']:
        try:
            # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            existing = sessions_table.get_item(
                Key={'taskId': item.get('taskId')}
            )
            
            if 'Item' not in existing:
                # å†™å…¥åˆ°sessionsè¡¨
                sessions_table.put_item(Item=item)
                migrated_count += 1
                print(f"âœ“ è¿ç§»è®°å½•: {item.get('taskId')}")
            else:
                print(f"â†’ è·³è¿‡å·²å­˜åœ¨è®°å½•: {item.get('taskId')}")
                
        except Exception as e:
            print(f"âŒ è¿ç§»å¤±è´¥: {item.get('taskId')} - {e}")
            failed_count += 1
    
    print(f"\nðŸ“Š è¿ç§»å®Œæˆ:")
    print(f"  æˆåŠŸ: {migrated_count}")
    print(f"  å¤±è´¥: {failed_count}")
    print(f"  è·³è¿‡: {len(backup_data['tasks']) - migrated_count - failed_count}")
    
    # æ­¥éª¤3: æ›´æ–°æ‰€æœ‰Lambdaå‡½æ•°ä½¿ç”¨sessionsè¡¨
    functions_to_update = [
        'ai-ppt-assistant-api-generate-presentation',
        'ai-ppt-assistant-api-presentation-status',
        'ai-ppt-assistant-api-list-presentations',
        'ai-ppt-assistant-api-get-task'
    ]
    
    sessions_table_name = 'ai-ppt-assistant-dev-sessions'
    
    # å­˜å‚¨åˆ°SSM
    ssm.put_parameter(
        Name="/ai-ppt-assistant/dev/dynamodb-table",
        Value=sessions_table_name,
        Type="String",
        Overwrite=True
    )
    
    for func_name in functions_to_update:
        try:
            response = lambda_client.get_function_configuration(
                FunctionName=func_name
            )
            
            env_vars = response.get('Environment', {}).get('Variables', {})
            env_vars['DYNAMODB_TABLE'] = sessions_table_name
            
            lambda_client.update_function_configuration(
                FunctionName=func_name,
                Environment={'Variables': env_vars}
            )
            
            print(f"âœ… æ›´æ–°å‡½æ•° {func_name} ä½¿ç”¨è¡¨: {sessions_table_name}")
            
        except Exception as e:
            print(f"âŒ æ›´æ–°å‡½æ•° {func_name} å¤±è´¥: {e}")

if __name__ == "__main__":
    migrate_data()
```

---

## ç¬¬äºŒé˜¶æ®µï¼šé…ç½®ä¸­å¿ƒåŒ–å’ŒIaCç®¡æŽ§

### 2.1 å»ºç«‹SSM Parameter Storeé…ç½®ä¸­å¿ƒ

```python
#!/usr/bin/env python3
# setup_config_center.py
import boto3
import json

ssm = boto3.client('ssm', region_name='us-east-1')

def setup_parameter_store():
    """å»ºç«‹å®Œæ•´çš„é…ç½®ä¸­å¿ƒ"""
    
    parameters = {
        # APIé…ç½®
        "/ai-ppt-assistant/dev/api-gateway-url": "https://otmr3noxg5.execute-api.us-east-1.amazonaws.com/dev",
        "/ai-ppt-assistant/dev/api-stage": "dev",
        
        # DynamoDBé…ç½®
        "/ai-ppt-assistant/dev/dynamodb-table": "ai-ppt-assistant-dev-sessions",
        "/ai-ppt-assistant/dev/dynamodb-region": "us-east-1",
        
        # S3é…ç½®
        "/ai-ppt-assistant/dev/s3-bucket": "ai-ppt-assistant-dev-storage",
        
        # SQSé…ç½®
        "/ai-ppt-assistant/dev/sqs-queue": "ai-ppt-assistant-dev-tasks",
        
        # çŽ¯å¢ƒé…ç½®
        "/ai-ppt-assistant/dev/environment": "development",
        "/ai-ppt-assistant/dev/log-level": "INFO",
        
        # ç‰ˆæœ¬ä¿¡æ¯
        "/ai-ppt-assistant/dev/version": "2.0.0",
        "/ai-ppt-assistant/dev/deployment-date": "2025-09-11"
    }
    
    print("ðŸ”§ é…ç½®SSM Parameter Store...")
    
    for name, value in parameters.items():
        try:
            # æ£€æŸ¥å‚æ•°æ˜¯å¦å­˜åœ¨
            try:
                existing = ssm.get_parameter(Name=name)
                print(f"â†’ æ›´æ–°å‚æ•°: {name}")
            except:
                print(f"âœ“ åˆ›å»ºå‚æ•°: {name}")
            
            # åˆ›å»ºæˆ–æ›´æ–°å‚æ•°
            ssm.put_parameter(
                Name=name,
                Value=value,
                Type="String",
                Overwrite=True,
                Description=f"Configuration for AI PPT Assistant - {name.split('/')[-1]}"
            )
            
        except Exception as e:
            print(f"âŒ å¤„ç†å‚æ•° {name} å¤±è´¥: {e}")
    
    print("âœ… é…ç½®ä¸­å¿ƒè®¾ç½®å®Œæˆ")

def create_lambda_config_reader():
    """åˆ›å»ºLambdaå‡½æ•°è¯»å–é…ç½®çš„è¾…åŠ©ä»£ç """
    
    code = '''
import boto3
import os
from functools import lru_cache

ssm = boto3.client('ssm', region_name=os.environ.get('AWS_REGION', 'us-east-1'))

@lru_cache(maxsize=128)
def get_parameter(name, decrypt=False):
    """ä»ŽSSM Parameter StoreèŽ·å–å‚æ•°å€¼"""
    try:
        response = ssm.get_parameter(Name=name, WithDecryption=decrypt)
        return response['Parameter']['Value']
    except Exception as e:
        # é™çº§åˆ°çŽ¯å¢ƒå˜é‡
        env_key = name.split('/')[-1].upper().replace('-', '_')
        return os.environ.get(env_key, '')

def get_config():
    """èŽ·å–å®Œæ•´é…ç½®"""
    prefix = "/ai-ppt-assistant/dev"
    
    return {
        'api_gateway_url': get_parameter(f'{prefix}/api-gateway-url'),
        'api_key': get_parameter(f'{prefix}/api-key', decrypt=True),
        'dynamodb_table': get_parameter(f'{prefix}/dynamodb-table'),
        's3_bucket': get_parameter(f'{prefix}/s3-bucket'),
        'sqs_queue': get_parameter(f'{prefix}/sqs-queue'),
        'environment': get_parameter(f'{prefix}/environment'),
    }

# ä½¿ç”¨ç¤ºä¾‹
config = get_config()
TABLE_NAME = config['dynamodb_table']
S3_BUCKET = config['s3_bucket']
'''
    
    # ä¿å­˜é…ç½®è¯»å–å™¨
    with open('lambda_config_reader.py', 'w') as f:
        f.write(code)
    
    print("âœ… Lambdaé…ç½®è¯»å–å™¨å·²åˆ›å»º: lambda_config_reader.py")

if __name__ == "__main__":
    setup_parameter_store()
    create_lambda_config_reader()
```

### 2.2 TerraformçŠ¶æ€åŒæ­¥å’ŒIaCå®Œå–„

```hcl
# terraform/modules/config/main.tf
# é…ç½®ä¸­å¿ƒåŒ–çš„Terraformæ¨¡å—

resource "aws_ssm_parameter" "api_config" {
  for_each = {
    api_gateway_url = "https://${var.api_gateway_id}.execute-api.${var.region}.amazonaws.com/${var.stage}"
    api_stage       = var.stage
    dynamodb_table  = "${var.project}-${var.environment}-sessions"
    s3_bucket       = "${var.project}-${var.environment}-storage"
  }
  
  name  = "/${var.project}/${var.environment}/${each.key}"
  type  = "String"
  value = each.value
  
  tags = var.tags
}

resource "aws_ssm_parameter" "api_key" {
  name  = "/${var.project}/${var.environment}/api-key"
  type  = "SecureString"
  value = var.api_key  # ä»Žterraform.tfvarsæˆ–çŽ¯å¢ƒå˜é‡ä¼ å…¥
  
  tags = var.tags
}

# Agentåˆ«åé…ç½®
resource "aws_ssm_parameter" "agent_aliases" {
  for_each = var.agent_configs
  
  name  = "/${var.project}/${var.environment}/agents/${each.key}/alias"
  type  = "String"
  value = "dev"  # ç»Ÿä¸€ä½¿ç”¨devåˆ«å
  
  tags = var.tags
}

# Lambdaå‡½æ•°çŽ¯å¢ƒå˜é‡å¼•ç”¨SSM
data "aws_ssm_parameter" "config" {
  for_each = toset([
    "api_gateway_url",
    "dynamodb_table",
    "s3_bucket"
  ])
  
  name = "/${var.project}/${var.environment}/${each.key}"
}

# è¾“å‡ºä¾›Lambdaæ¨¡å—ä½¿ç”¨
output "lambda_environment_variables" {
  value = {
    CONFIG_SOURCE     = "SSM_PARAMETER_STORE"
    PARAMETER_PREFIX  = "/${var.project}/${var.environment}"
    DYNAMODB_TABLE    = data.aws_ssm_parameter.config["dynamodb_table"].value
    S3_BUCKET         = data.aws_ssm_parameter.config["s3_bucket"].value
    API_GATEWAY_URL   = data.aws_ssm_parameter.config["api_gateway_url"].value
  }
}
```

### 2.3 å¯¼å…¥çŽ°æœ‰èµ„æºåˆ°TerraformçŠ¶æ€

```bash
#!/bin/bash
# import_terraform_resources.sh

cd infrastructure

echo "ðŸ”„ å¯¼å…¥çŽ°æœ‰èµ„æºåˆ°TerraformçŠ¶æ€..."

# å¯¼å…¥IAMè§’è‰²
terraform import module.bedrock.aws_iam_role.agent_roles[\"compiler\"] \
  ai-ppt-assistant-compiler-agent-role

terraform import module.bedrock.aws_iam_role.agent_roles[\"orchestrator\"] \
  ai-ppt-assistant-orchestrator-agent-role

terraform import module.bedrock.aws_iam_role.agent_roles[\"visual\"] \
  ai-ppt-assistant-visual-agent-role

terraform import module.bedrock.aws_iam_role.agent_roles[\"content\"] \
  ai-ppt-assistant-content-agent-role

# å¯¼å…¥IAMç­–ç•¥
ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)

terraform import module.bedrock.aws_iam_policy.agent_policies[\"compiler\"] \
  arn:aws:iam::${ACCOUNT_ID}:policy/ai-ppt-assistant-compiler-agent-policy

terraform import module.bedrock.aws_iam_policy.agent_policies[\"orchestrator\"] \
  arn:aws:iam::${ACCOUNT_ID}:policy/ai-ppt-assistant-orchestrator-agent-policy

terraform import module.bedrock.aws_iam_policy.agent_policies[\"visual\"] \
  arn:aws:iam::${ACCOUNT_ID}:policy/ai-ppt-assistant-visual-agent-policy

terraform import module.bedrock.aws_iam_policy.agent_policies[\"content\"] \
  arn:aws:iam::${ACCOUNT_ID}:policy/ai-ppt-assistant-content-agent-policy

# å¯¼å…¥CloudWatchæ—¥å¿—ç»„
terraform import module.monitoring.aws_cloudwatch_log_group.insights \
  /aws/cloudwatch/insights/ai-ppt-assistant-dev

# å¯¼å…¥KMSåˆ«å
terraform import module.kms.aws_kms_alias.sns_key \
  alias/ai-ppt-assistant-dev-sns-key

echo "âœ… èµ„æºå¯¼å…¥å®Œæˆ"

# éªŒè¯çŠ¶æ€
terraform plan -out=tfplan

if [ $? -eq 0 ]; then
  echo "âœ… TerraformçŠ¶æ€åŒæ­¥æˆåŠŸ"
else
  echo "âŒ TerraformçŠ¶æ€å­˜åœ¨é—®é¢˜ï¼Œè¯·æ£€æŸ¥"
fi
```

---

## ç¬¬ä¸‰é˜¶æ®µï¼šCI/CDå’Œè‡ªåŠ¨éªŒè¯

### 3.1 éƒ¨ç½²åŽè‡ªåŠ¨éªŒè¯è„šæœ¬

```python
#!/usr/bin/env python3
# post_deploy_validation.py
import boto3
import requests
import json
import sys
from datetime import datetime

def validate_deployment():
    """éƒ¨ç½²åŽè‡ªåŠ¨éªŒè¯"""
    
    ssm = boto3.client('ssm', region_name='us-east-1')
    
    # èŽ·å–é…ç½®
    api_url = ssm.get_parameter(Name='/ai-ppt-assistant/dev/api-gateway-url')['Parameter']['Value']
    api_key = ssm.get_parameter(Name='/ai-ppt-assistant/dev/api-key', WithDecryption=True)['Parameter']['Value']
    
    validations = []
    
    # 1. å¥åº·æ£€æŸ¥
    print("ðŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥...")
    try:
        response = requests.get(
            f"{api_url}/health",
            headers={'x-api-key': api_key},
            timeout=10
        )
        validations.append({
            'test': 'Health Check',
            'status': response.status_code == 200,
            'message': f"Status: {response.status_code}"
        })
    except Exception as e:
        validations.append({
            'test': 'Health Check',
            'status': False,
            'message': str(e)
        })
    
    # 2. åˆ›å»ºæ¼”ç¤ºæ–‡ç¨¿æµ‹è¯•
    print("ðŸ” æµ‹è¯•åˆ›å»ºæ¼”ç¤ºæ–‡ç¨¿...")
    try:
        response = requests.post(
            f"{api_url}/presentations",
            headers={'x-api-key': api_key},
            json={
                'topic': 'Deployment Test',
                'slides': 3,
                'test': True
            },
            timeout=30
        )
        
        if response.status_code in [200, 201, 202]:
            task_id = response.json().get('taskId')
            validations.append({
                'test': 'Create Presentation',
                'status': True,
                'message': f"Task ID: {task_id}"
            })
        else:
            validations.append({
                'test': 'Create Presentation',
                'status': False,
                'message': f"Status: {response.status_code}"
            })
    except Exception as e:
        validations.append({
            'test': 'Create Presentation',
            'status': False,
            'message': str(e)
        })
    
    # 3. éªŒè¯Lambdaé…ç½®
    print("ðŸ” éªŒè¯Lambdaé…ç½®...")
    lambda_client = boto3.client('lambda', region_name='us-east-1')
    
    functions = [
        'ai-ppt-assistant-api-generate-presentation',
        'ai-ppt-assistant-generate-content',
        'ai-ppt-assistant-generate-image',
        'ai-ppt-assistant-compile-pptx'
    ]
    
    for func_name in functions:
        try:
            config = lambda_client.get_function_configuration(FunctionName=func_name)
            env_vars = config.get('Environment', {}).get('Variables', {})
            
            # æ£€æŸ¥å…³é”®çŽ¯å¢ƒå˜é‡
            has_config = 'CONFIG_SOURCE' in env_vars
            
            validations.append({
                'test': f'Lambda Config: {func_name.split("-")[-1]}',
                'status': has_config,
                'message': 'Config source: SSM' if has_config else 'Missing config'
            })
        except Exception as e:
            validations.append({
                'test': f'Lambda Config: {func_name.split("-")[-1]}',
                'status': False,
                'message': str(e)
            })
    
    # ç”ŸæˆæŠ¥å‘Š
    print("\n" + "="*60)
    print("éƒ¨ç½²éªŒè¯æŠ¥å‘Š")
    print("="*60)
    
    passed = sum(1 for v in validations if v['status'])
    total = len(validations)
    
    for validation in validations:
        status_icon = "âœ…" if validation['status'] else "âŒ"
        print(f"{status_icon} {validation['test']}: {validation['message']}")
    
    print("\n" + "-"*60)
    print(f"ç»“æžœ: {passed}/{total} é€šè¿‡")
    
    # ä¿å­˜æŠ¥å‘Š
    report = {
        'timestamp': datetime.now().isoformat(),
        'validations': validations,
        'summary': {
            'total': total,
            'passed': passed,
            'failed': total - passed,
            'success_rate': f"{(passed/total)*100:.1f}%"
        }
    }
    
    with open('deployment_validation_report.json', 'w') as f:
        json.dump(report, f, indent=2)
    
    # è¿”å›žçŠ¶æ€ç 
    return 0 if passed == total else 1

if __name__ == "__main__":
    sys.exit(validate_deployment())
```

### 3.2 Makeå‘½ä»¤æ”¹è¿›

```makefile
# Makefile æ”¹è¿›ç‰ˆ

.PHONY: deploy deploy-safe rollback validate

# å®‰å…¨éƒ¨ç½²ï¼ˆå¸¦éªŒè¯ï¼‰
deploy-safe:
	@echo "ðŸš€ å¼€å§‹å®‰å…¨éƒ¨ç½²..."
	@# å¤‡ä»½å½“å‰çŠ¶æ€
	@cd infrastructure && cp terraform.tfstate terraform.tfstate.backup.$(shell date +%Y%m%d-%H%M%S)
	@# æ‰§è¡Œéƒ¨ç½²
	@$(MAKE) deploy
	@# æ‰§è¡ŒéªŒè¯
	@$(MAKE) validate
	@if [ $$? -ne 0 ]; then \
		echo "âŒ éªŒè¯å¤±è´¥ï¼Œå¼€å§‹å›žæ»š..."; \
		$(MAKE) rollback; \
		exit 1; \
	fi
	@echo "âœ… éƒ¨ç½²æˆåŠŸå¹¶é€šè¿‡éªŒè¯"

# éªŒè¯éƒ¨ç½²
validate:
	@echo "ðŸ” éªŒè¯éƒ¨ç½²..."
	@python3 post_deploy_validation.py

# å›žæ»š
rollback:
	@echo "âª æ‰§è¡Œå›žæ»š..."
	@cd infrastructure && \
		cp terraform.tfstate.backup.$(shell ls -t terraform.tfstate.backup.* | head -1 | cut -d. -f3-) terraform.tfstate && \
		terraform apply -auto-approve
	@echo "âœ… å›žæ»šå®Œæˆ"

# é…ç½®åŒæ­¥
sync-config:
	@echo "ðŸ”„ åŒæ­¥é…ç½®åˆ°SSM..."
	@python3 setup_config_center.py
	@python3 fix_agent_config.py
	@echo "âœ… é…ç½®åŒæ­¥å®Œæˆ"
```

---

## ç¬¬å››é˜¶æ®µï¼šç›‘æŽ§å’Œé•¿æœŸä¼˜åŒ–

### 4.1 CloudWatchå‘Šè­¦ä¼˜åŒ–

```python
#!/usr/bin/env python3
# setup_monitoring.py
import boto3

cloudwatch = boto3.client('cloudwatch', region_name='us-east-1')

def setup_alarms():
    """è®¾ç½®ä¼˜åŒ–çš„CloudWatchå‘Šè­¦"""
    
    # Lambdaå‡½æ•°é”™è¯¯çŽ‡å‘Šè­¦
    functions = [
        'ai-ppt-assistant-api-generate-presentation',
        'ai-ppt-assistant-generate-content',
        'ai-ppt-assistant-generate-image',
        'ai-ppt-assistant-compile-pptx'
    ]
    
    for func_name in functions:
        # é”™è¯¯çŽ‡å‘Šè­¦
        cloudwatch.put_metric_alarm(
            AlarmName=f"{func_name}-error-rate",
            ComparisonOperator='GreaterThanThreshold',
            EvaluationPeriods=2,
            MetricName='Errors',
            Namespace='AWS/Lambda',
            Period=300,
            Statistic='Sum',
            Threshold=5.0,
            ActionsEnabled=True,
            AlarmDescription=f'Error rate for {func_name}',
            Dimensions=[
                {
                    'Name': 'FunctionName',
                    'Value': func_name
                }
            ],
            TreatMissingData='notBreaching'
        )
        
        # æŒç»­æ—¶é—´å‘Šè­¦
        cloudwatch.put_metric_alarm(
            AlarmName=f"{func_name}-duration",
            ComparisonOperator='GreaterThanThreshold',
            EvaluationPeriods=2,
            MetricName='Duration',
            Namespace='AWS/Lambda',
            Period=300,
            Statistic='Average',
            Threshold=10000.0,  # 10ç§’
            ActionsEnabled=True,
            AlarmDescription=f'Duration alarm for {func_name}',
            Dimensions=[
                {
                    'Name': 'FunctionName',
                    'Value': func_name
                }
            ],
            TreatMissingData='notBreaching'
        )
    
    print("âœ… CloudWatchå‘Šè­¦è®¾ç½®å®Œæˆ")

if __name__ == "__main__":
    setup_alarms()
```

### 4.2 S3ç”Ÿå‘½å‘¨æœŸå’ŒDynamoDBå¤‡ä»½

```bash
#!/bin/bash
# setup_data_management.sh

# S3ç”Ÿå‘½å‘¨æœŸç­–ç•¥
cat > s3-lifecycle.json << 'EOF'
{
  "Rules": [
    {
      "Id": "DeleteOldPresentations",
      "Status": "Enabled",
      "Expiration": {
        "Days": 30
      },
      "NoncurrentVersionExpiration": {
        "NoncurrentDays": 7
      },
      "Filter": {
        "Prefix": "presentations/"
      }
    },
    {
      "Id": "TransitionToIA",
      "Status": "Enabled",
      "Transitions": [
        {
          "Days": 7,
          "StorageClass": "STANDARD_IA"
        },
        {
          "Days": 30,
          "StorageClass": "GLACIER"
        }
      ],
      "Filter": {
        "Prefix": "archives/"
      }
    }
  ]
}
EOF

aws s3api put-bucket-lifecycle-configuration \
  --bucket ai-ppt-assistant-dev-storage \
  --lifecycle-configuration file://s3-lifecycle.json \
  --region us-east-1

echo "âœ… S3ç”Ÿå‘½å‘¨æœŸç­–ç•¥å·²é…ç½®"

# DynamoDBå¤‡ä»½
for table in sessions tasks checkpoints; do
  # å¯ç”¨Point-in-time Recovery
  aws dynamodb update-continuous-backups \
    --table-name ai-ppt-assistant-dev-$table \
    --point-in-time-recovery-specification PointInTimeRecoveryEnabled=true \
    --region us-east-1
  
  echo "âœ… å¯ç”¨è¡¨ $table çš„PITRå¤‡ä»½"
done

# åˆ›å»ºæŒ‰éœ€å¤‡ä»½
aws dynamodb create-backup \
  --table-name ai-ppt-assistant-dev-sessions \
  --backup-name "ai-ppt-assistant-dev-sessions-$(date +%Y%m%d)" \
  --region us-east-1

echo "âœ… æ•°æ®ç®¡ç†ç­–ç•¥é…ç½®å®Œæˆ"
```

---

## æ‰§è¡Œè®¡åˆ’æ€»ç»“

### ðŸš¨ ç«‹å³æ‰§è¡Œï¼ˆ0-1å°æ—¶ï¼‰
1. **APIå¯†é’¥è½®æ¢å’Œå®‰å…¨åŠ å›º**
   ```bash
   bash -c "$(curl -fsSL emergency_security_fix.sh)"
   ```

### ðŸ”§ ç¬¬ä¸€å¤©ï¼ˆ4-6å°æ—¶ï¼‰
2. **æ ¸å¿ƒåŠŸèƒ½ä¿®å¤**
   ```bash
   python3 fix_agent_config.py
   bash unify_api_gateway.sh
   python3 migrate_dynamodb_data.py
   ```

3. **é…ç½®ä¸­å¿ƒåŒ–**
   ```bash
   python3 setup_config_center.py
   bash import_terraform_resources.sh
   ```

### ðŸ“Š ç¬¬äºŒå¤©ï¼ˆæŒç»­ä¼˜åŒ–ï¼‰
4. **CI/CDå’Œç›‘æŽ§**
   ```bash
   make deploy-safe
   python3 setup_monitoring.py
   bash setup_data_management.sh
   ```

## æˆåŠŸæ ‡å‡†

### å¿…é¡»è¾¾æˆ âœ…
- [ ] APIå¯†é’¥å·²è½®æ¢ï¼Œæ—§å¯†é’¥å·²ç¦ç”¨
- [ ] æ‰€æœ‰Agentä½¿ç”¨åˆ«åè€Œéžç¡¬ç¼–ç ID
- [ ] åªæœ‰ä¸€ä¸ªAPI Gatewayå’Œä¸€ä¸ªStageï¼ˆdevï¼‰
- [ ] DynamoDBæ•°æ®ç»Ÿä¸€åˆ°sessionsè¡¨
- [ ] é…ç½®å…¨éƒ¨å­˜å‚¨åœ¨SSM Parameter Store
- [ ] TerraformçŠ¶æ€ä¸Žå®žé™…èµ„æºåŒæ­¥
- [ ] éƒ¨ç½²åŽè‡ªåŠ¨éªŒè¯é€šè¿‡

### åº”è¯¥è¾¾æˆ ðŸ“ˆ
- [ ] CloudWatchå‘Šè­¦æ­£å¸¸å·¥ä½œ
- [ ] S3ç”Ÿå‘½å‘¨æœŸç­–ç•¥å·²é…ç½®
- [ ] DynamoDBå¤‡ä»½å·²å¯ç”¨
- [ ] Lambdaå¹¶å‘é™åˆ¶å·²è®¾ç½®
- [ ] X-Rayè¿½è¸ªå·²å¯ç”¨

### æŒç»­æ”¹è¿› ðŸ”„
- [ ] è‡ªå®šä¹‰åŸŸåé…ç½®
- [ ] APIç‰ˆæœ¬ç®¡ç†å®žæ–½
- [ ] ç»†ç²’åº¦é™æµé…ç½®
- [ ] æˆæœ¬ä¼˜åŒ–æŽªæ–½

## é£Žé™©ç¼“è§£

### å¤‡ä»½ç­–ç•¥
- æ‰€æœ‰æ“ä½œå‰åˆ›å»ºå¤‡ä»½
- TerraformçŠ¶æ€æ–‡ä»¶ç‰ˆæœ¬æŽ§åˆ¶
- DynamoDBæ•°æ®å¯¼å‡ºä¿å­˜
- é…ç½®å˜æ›´è®°å½•å®¡è®¡

### å›žæ»šæ–¹æ¡ˆ
- æ¯ä¸ªé˜¶æ®µéƒ½æœ‰ç‹¬ç«‹å›žæ»šè„šæœ¬
- ä¿ç•™24å°æ—¶å†…çš„æ‰€æœ‰å¤‡ä»½
- ç´§æ€¥è”ç³»æ–¹å¼å’Œå‡çº§è·¯å¾„

## è”ç³»æ”¯æŒ

**æŠ€æœ¯æ”¯æŒ**: aws-support@company.com  
**ç´§æ€¥ç”µè¯**: +1-xxx-xxx-xxxx  
**Slack**: #ai-ppt-assistant-ops  
**æ–‡æ¡£åº“**: https://wiki.company.com/ai-ppt-assistant

---

**æ–‡æ¡£ç‰ˆæœ¬åŽ†å²**:
- v2.0 (2025-09-11): åŸºäºŽGè€å¸ˆå»ºè®®çš„æ”¹è¿›ç‰ˆï¼Œå¢žåŠ é•¿æœŸç¨³æ€æ–¹æ¡ˆ
- v1.0 (2025-09-11): åˆå§‹ç‰ˆæœ¬

**ä¸‹æ¬¡æ›´æ–°**: éƒ¨ç½²å®ŒæˆåŽçš„å®žæ–½æŠ¥å‘Š