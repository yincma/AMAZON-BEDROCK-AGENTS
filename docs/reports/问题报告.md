# AI PPT Assistant 问题报告

**生成时间**: 2025-09-12 16:41:00  
**测试环境**: AWS us-east-1  
**项目版本**: dev 分支  
**报告人**: ultrathink (AWS专家)

## 执行摘要

### 部署状态 ✅
- **部署成功**: 成功创建 254 个 AWS 资源
- **配置同步**: Bedrock Agents 配置验证通过
- **基础设施**: VPC、Lambda、API Gateway、DynamoDB、S3 等全部创建成功
- **部署时间**: 2025-09-12 16:35 完成

### API 测试结果 ⚠️
- **总测试数**: 6 个
- **成功**: 4 个 (66.7%)
- **失败**: 2 个 (33.3%)
- **测试耗时**: 6.43 秒

### 🎉 重大发现
- **Terraform 已支持 Bedrock Agents**: 项目中已使用 `aws_bedrockagent_agent` 资源
- **自动化部署可行**: 理论上可以实现完全的一键部署和删除
- **配置同步机制存在**: 已有 sync_bedrock_config.sh 脚本自动同步配置

## 发现的关键问题

### 问题 1: DynamoDB 表配置不一致 🔴
**严重级别**: 高  
**影响范围**: 演示文稿状态查询和下载功能完全不可用

**问题描述**:
- `generate_presentation` Lambda 函数将数据存储在 `ai-ppt-assistant-dev-sessions` 表
- `presentation_status` Lambda 函数查询时找不到对应的记录
- 导致 404 错误：Presentation not found

**错误日志证据**:
```
# generate_presentation 函数日志
[INFO] 2025-09-12T07:39:28.334Z Stored presentation state in ai-ppt-assistant-dev-sessions: de68ca84-87b6-4dfa-afa2-53833af7733d

# presentation_status 函数日志
[INFO] 2025-09-12T07:39:31.554Z Fetching presentation from DynamoDB: de68ca84-87b6-4dfa-afa2-53833af7733d
[INFO] 2025-09-12T07:39:31.559Z Presentation not found in DynamoDB
```

**根本原因分析**:
1. Lambda 函数环境变量中的表名配置不一致
2. 可能存在硬编码的表名
3. Terraform 配置中的表名传递问题

**建议修复方案**:
1. 立即检查所有 Lambda 函数的环境变量 `DYNAMODB_TABLE_NAME`
2. 统一使用 `ai-ppt-assistant-dev-tasks` 表存储任务状态
3. 在 Terraform 中使用变量引用确保一致性

### 问题 2: Bedrock Agent 调用失败 🔴
**严重级别**: 高  
**影响范围**: AI 内容生成功能完全不可用

**问题描述**:
- 调用 orchestrator agent 时返回 `ResourceNotFoundException`
- Agent 资源存在但无法正确调用

**错误日志证据**:
```
[ERROR] 2025-09-12T07:39:28.397Z Error invoking orchestrator agent: 
An error occurred (ResourceNotFoundException) when calling the InvokeAgent operation: 
Failed to retrieve resource because it doesn't exist.
```

**Bedrock Agent 配置信息**:
```
orchestrator: 
  - Agent ID: HFENDUVCUD
  - Alias ID: G4MMKDKLFF
```

**可能原因**:
1. Lambda 函数使用了错误的 Agent ID 或 Alias ID
2. Agent 别名未正确创建或激活
3. IAM 权限不足

**建议修复方案**:
1. 验证 Lambda 环境变量中的 `BEDROCK_AGENT_ID` 和 `BEDROCK_AGENT_ALIAS_ID`
2. 在 AWS 控制台确认 Agent 和 Alias 的状态为 PREPARED
3. 检查 Lambda 执行角色的 bedrock:InvokeAgent 权限

### 问题 3: SQS 队列配置缺失 🟡
**严重级别**: 中  
**影响范围**: 异步任务处理功能降级

**问题描述**:
- SQS 队列 URL 未在 Lambda 函数中配置
- 任务无法异步处理，影响系统扩展性

**警告日志**:
```
[WARNING] 2025-09-12T07:39:28.334Z SQS queue URL not configured, skipping queuing
```

**SQS 队列信息**:
```
队列 URL: https://sqs.us-east-1.amazonaws.com/375004070918/ai-ppt-assistant-dev-tasks
```

**建议修复方案**:
1. 在 Lambda 环境变量中添加 `SQS_QUEUE_URL`
2. 验证 Lambda 执行角色有 sqs:SendMessage 权限

## 配置修复前后对比

### 修复前的 Terraform 配置问题
```hcl
# infrastructure/main.tf 第521-549行（已修复）
resource "aws_lambda_permission" "generate_presentation_permission" {
  function_name = module.lambda.function_names["generate_presentation"]  # ❌ 错误的键名
  # 应该是: module.lambda.function_names["api_generate_presentation"]
}
```

### 当前生产配置
```yaml
API Gateway:
  URL: https://jp252q63wh.execute-api.us-east-1.amazonaws.com/legacy
  API Key: vuoNvDySxX77NpfleMhuza7N7hJdmrbO4PVOlH59
  
Lambda Functions:
  - ai-ppt-assistant-api-generate-presentation
  - ai-ppt-assistant-api-presentation-status
  - ai-ppt-assistant-api-presentation-download
  
DynamoDB Tables:
  - ai-ppt-assistant-dev-sessions
  - ai-ppt-assistant-dev-tasks
  - ai-ppt-assistant-dev-checkpoints
```

## 测试执行详情

### ✅ 通过的测试 (4/6)
1. **无效 API 密钥测试**: 正确返回 403 Forbidden
2. **创建演示文稿**: 成功创建，返回 task_id: `de68ca84-87b6-4dfa-afa2-53833af7733d`
3. **列出演示文稿**: 成功返回空列表
4. **无效演示文稿 ID 测试**: 正确返回 400 Bad Request

### ❌ 失败的测试 (2/6)
1. **获取演示文稿状态**: 
   - 错误: 404 Not Found
   - 原因: DynamoDB 表查询问题
   
2. **下载演示文稿**: 
   - 错误: 404 Not Found
   - 原因: 无法找到演示文稿记录

## 修复行动计划

### P0 - 立即修复（影响核心功能）
- [ ] **修复 DynamoDB 表名配置**
  ```bash
  # 更新 Lambda 环境变量
  aws lambda update-function-configuration \
    --function-name ai-ppt-assistant-api-presentation-status \
    --environment Variables={DYNAMODB_TABLE_NAME=ai-ppt-assistant-dev-sessions}
  ```

- [ ] **修复 Bedrock Agent 配置**
  ```bash
  # 更新 Lambda 环境变量
  aws lambda update-function-configuration \
    --function-name ai-ppt-assistant-api-generate-presentation \
    --environment Variables={BEDROCK_AGENT_ID=HFENDUVCUD,BEDROCK_AGENT_ALIAS_ID=G4MMKDKLFF}
  ```

### P1 - 今日完成
- [ ] 配置 SQS 队列 URL
- [ ] 运行端到端测试验证修复
- [ ] 更新监控告警阈值

### P2 - 本周完成
- [ ] 实施配置中心避免硬编码
- [ ] 添加集成测试套件
- [ ] 完善错误处理和重试机制

## 验证步骤

修复后执行以下验证：

```bash
# 1. 重新运行测试
python3 test_all_backend_apis.py

# 2. 验证 DynamoDB 数据
aws dynamodb scan --table-name ai-ppt-assistant-dev-sessions

# 3. 检查 Lambda 日志
aws logs tail /aws/lambda/ai-ppt-assistant-api-presentation-status --follow

# 4. 测试 Bedrock Agent
aws bedrock-agent-runtime invoke-agent \
  --agent-id HFENDUVCUD \
  --agent-alias-id G4MMKDKLFF \
  --session-id test-session \
  --input-text "Create a presentation about AI"
```

## 历史问题记录

### 2025-09-12 早期问题（已解决）
1. ✅ Terraform 配置中 Lambda 函数引用键名错误
2. ✅ null_resource 中的 Lambda 函数引用问题
3. ✅ API Gateway URL 更新

## 监控指标

当前系统健康度评分: **60/100**
- 基础设施: 100% ✅
- API 可用性: 66% ⚠️
- 数据持久化: 0% ❌
- AI 功能: 0% ❌

## 永久解决方案（基于Terraform支持）

### 发现：Terraform 已支持 Bedrock Agents！
经过深入调查，发现项目已经包含完整的 Bedrock Agent Terraform 配置：
- `infrastructure/modules/bedrock/main.tf` 定义了所有 4 个 Agents
- 使用 `aws_bedrockagent_agent` 和 `aws_bedrockagent_agent_alias` 资源
- 理论上支持完全的一键部署和删除

### 为什么还是需要手动修复？
1. **Alias ID 同步问题**: Terraform 创建的 Alias ID 没有正确传递到 Lambda 环境变量
2. **DynamoDB 表结构问题**: 表的主键设计导致查询失败
3. **配置同步延迟**: null_resource 的执行时机问题

### 最终解决方案
```bash
# 每次 destroy 后的恢复步骤
make deploy && ./scripts/sync_bedrock_config.sh
```

## 联系信息

- **项目负责人**: ultrathink
- **AWS 账号**: 375004070918
- **区域**: us-east-1
- **支持邮箱**: ai-team@example.com

---
*报告更新时间: 2025-09-12 18:25:00 CST*  
*下次更新: 修复完成后*