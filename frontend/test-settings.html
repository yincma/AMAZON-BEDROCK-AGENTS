<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¾ç½®é¡µé¢åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f3f4f6;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        h1 {
            color: #1f2937;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }
        h2 {
            color: #374151;
            margin-top: 20px;
        }
        .test-item {
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #e5e7eb;
            background: #f9fafb;
        }
        .test-pass {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .test-fail {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .test-pending {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        button {
            background: #3b82f6;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        .status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-pass {
            background: #10b981;
            color: white;
        }
        .status-fail {
            background: #ef4444;
            color: white;
        }
        .status-pending {
            background: #f59e0b;
            color: white;
        }
        .log-area {
            background: #1f2937;
            color: #e5e7eb;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-success { color: #10b981; }
        .log-error { color: #ef4444; }
        .log-info { color: #3b82f6; }
        .log-warning { color: #f59e0b; }
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ§ª è®¾ç½®é¡µé¢è‡ªåŠ¨åŒ–æµ‹è¯•</h1>
        <p>æ­¤æµ‹è¯•å°†éªŒè¯ http://localhost:5173/settings/preferences é¡µé¢çš„æ‰€æœ‰åŠŸèƒ½</p>
        
        <div style="margin: 20px 0;">
            <button onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
            <button onclick="clearResults()">ğŸ”„ æ¸…é™¤ç»“æœ</button>
            <button onclick="openSettingsPage()">ğŸ“– æ‰“å¼€è®¾ç½®é¡µé¢</button>
        </div>

        <div class="test-container">
            <h2>æµ‹è¯•ç”¨ä¾‹åˆ—è¡¨</h2>
            <div id="test-results"></div>
        </div>

        <div class="test-container">
            <h2>æµ‹è¯•æ—¥å¿—</h2>
            <div class="log-area" id="log-area"></div>
        </div>

        <div class="test-container">
            <h2>æµ‹è¯•é¡µé¢é¢„è§ˆ</h2>
            <iframe id="test-frame" src="http://localhost:5173/settings/preferences"></iframe>
        </div>
    </div>

    <script>
        const testCases = [
            {
                id: 'route-test',
                name: 'è·¯ç”±å’Œé¡µé¢åŠ è½½æµ‹è¯•',
                async test() {
                    log('info', 'å¼€å§‹æµ‹è¯•è·¯ç”±å’Œé¡µé¢åŠ è½½...');
                    
                    // æµ‹è¯•é¡µé¢æ˜¯å¦å¯è®¿é—®
                    const response = await fetch('http://localhost:5173/settings/preferences');
                    if (!response.ok) {
                        throw new Error(`é¡µé¢è¿”å›çŠ¶æ€ç : ${response.status}`);
                    }
                    
                    log('success', 'âœ“ é¡µé¢æˆåŠŸåŠ è½½');
                    return true;
                }
            },
            {
                id: 'api-config-test',
                name: 'APIé…ç½®é¢æ¿æµ‹è¯•',
                async test() {
                    log('info', 'æµ‹è¯•APIé…ç½®é¢æ¿åŠŸèƒ½...');
                    
                    // æµ‹è¯•localStorageå­˜å‚¨
                    const testConfig = {
                        baseUrl: 'https://test-api.example.com',
                        apiKey: 'test-key-123',
                        timeout: 30000,
                        retryAttempts: 3,
                        enableCache: true,
                        cacheTimeout: 300000,
                        enableCompression: true,
                        maxConcurrentRequests: 5,
                        customHeaders: {}
                    };
                    
                    localStorage.setItem('api-config', JSON.stringify(testConfig));
                    const savedConfig = JSON.parse(localStorage.getItem('api-config'));
                    
                    if (savedConfig.baseUrl !== testConfig.baseUrl) {
                        throw new Error('APIé…ç½®ä¿å­˜å¤±è´¥');
                    }
                    
                    log('success', 'âœ“ APIé…ç½®ä¿å­˜å’ŒåŠ è½½æˆåŠŸ');
                    
                    // æµ‹è¯•å¥åº·æ£€æŸ¥API
                    try {
                        const healthResponse = await fetch('https://byih5fsutb.execute-api.us-east-1.amazonaws.com/dev/health', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            signal: AbortSignal.timeout(5000)
                        });
                        
                        if (healthResponse.ok) {
                            log('success', 'âœ“ APIå¥åº·æ£€æŸ¥æˆåŠŸ');
                        } else {
                            log('warning', 'âš  APIå¥åº·æ£€æŸ¥è¿”å›é200çŠ¶æ€');
                        }
                    } catch (error) {
                        log('warning', `âš  APIå¥åº·æ£€æŸ¥å¤±è´¥: ${error.message}`);
                    }
                    
                    return true;
                }
            },
            {
                id: 'theme-test',
                name: 'ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½æµ‹è¯•',
                async test() {
                    log('info', 'æµ‹è¯•ä¸»é¢˜åˆ‡æ¢åŠŸèƒ½...');
                    
                    // æµ‹è¯•ä¸»é¢˜å­˜å‚¨
                    const themes = ['light', 'dark', 'system'];
                    
                    for (const theme of themes) {
                        localStorage.setItem('ui-theme', theme);
                        const savedTheme = localStorage.getItem('ui-theme');
                        
                        if (savedTheme !== theme) {
                            throw new Error(`ä¸»é¢˜ ${theme} ä¿å­˜å¤±è´¥`);
                        }
                        
                        log('success', `âœ“ ä¸»é¢˜ "${theme}" ä¿å­˜æˆåŠŸ`);
                    }
                    
                    return true;
                }
            },
            {
                id: 'language-test',
                name: 'è¯­è¨€è®¾ç½®æµ‹è¯•',
                async test() {
                    log('info', 'æµ‹è¯•è¯­è¨€è®¾ç½®åŠŸèƒ½...');
                    
                    const languages = ['zh', 'en'];
                    
                    for (const lang of languages) {
                        localStorage.setItem('ui-language', lang);
                        const savedLang = localStorage.getItem('ui-language');
                        
                        if (savedLang !== lang) {
                            throw new Error(`è¯­è¨€ ${lang} ä¿å­˜å¤±è´¥`);
                        }
                        
                        log('success', `âœ“ è¯­è¨€ "${lang}" ä¿å­˜æˆåŠŸ`);
                    }
                    
                    return true;
                }
            },
            {
                id: 'storage-test',
                name: 'LocalStorage æŒä¹…åŒ–æµ‹è¯•',
                async test() {
                    log('info', 'æµ‹è¯•LocalStorageæŒä¹…åŒ–...');
                    
                    // è®¾ç½®æµ‹è¯•æ•°æ®
                    const testData = {
                        testKey: 'testValue',
                        timestamp: Date.now()
                    };
                    
                    localStorage.setItem('test-persistence', JSON.stringify(testData));
                    
                    // æ¸…é™¤å¹¶é‡æ–°è¯»å–
                    const saved = JSON.parse(localStorage.getItem('test-persistence'));
                    
                    if (!saved || saved.testKey !== testData.testKey) {
                        throw new Error('æ•°æ®æŒä¹…åŒ–å¤±è´¥');
                    }
                    
                    log('success', 'âœ“ LocalStorageæŒä¹…åŒ–æ­£å¸¸');
                    
                    // æ¸…ç†æµ‹è¯•æ•°æ®
                    localStorage.removeItem('test-persistence');
                    
                    return true;
                }
            },
            {
                id: 'ui-store-test',
                name: 'UI Store çŠ¶æ€ç®¡ç†æµ‹è¯•',
                async test() {
                    log('info', 'æµ‹è¯•UI StoreçŠ¶æ€ç®¡ç†...');
                    
                    // æµ‹è¯•toasté€šçŸ¥å­˜å‚¨
                    const toastTest = {
                        type: 'success',
                        title: 'æµ‹è¯•é€šçŸ¥',
                        message: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•é€šçŸ¥'
                    };
                    
                    // æ¨¡æ‹Ÿé€šçŸ¥å­˜å‚¨
                    sessionStorage.setItem('ui-toasts', JSON.stringify([toastTest]));
                    const savedToasts = JSON.parse(sessionStorage.getItem('ui-toasts') || '[]');
                    
                    if (savedToasts.length > 0) {
                        log('success', 'âœ“ UIé€šçŸ¥çŠ¶æ€ç®¡ç†æ­£å¸¸');
                    }
                    
                    // æ¸…ç†
                    sessionStorage.removeItem('ui-toasts');
                    
                    return true;
                }
            },
            {
                id: 'form-validation-test',
                name: 'è¡¨å•éªŒè¯æµ‹è¯•',
                async test() {
                    log('info', 'æµ‹è¯•è¡¨å•éªŒè¯é€»è¾‘...');
                    
                    // æµ‹è¯•API URLéªŒè¯
                    const validUrls = [
                        'http://localhost:8000',
                        'https://api.example.com',
                        'https://api.example.com:3000/v1'
                    ];
                    
                    const invalidUrls = [
                        '',
                        'not-a-url',
                        'ftp://invalid.com'
                    ];
                    
                    for (const url of validUrls) {
                        try {
                            new URL(url);
                            log('success', `âœ“ æœ‰æ•ˆURL: ${url}`);
                        } catch {
                            throw new Error(`åº”è¯¥æ˜¯æœ‰æ•ˆURLä½†éªŒè¯å¤±è´¥: ${url}`);
                        }
                    }
                    
                    for (const url of invalidUrls) {
                        try {
                            if (url === '') {
                                log('success', 'âœ“ ç©ºURLæ­£ç¡®è¢«è¯†åˆ«ä¸ºæ— æ•ˆ');
                            } else {
                                new URL(url);
                                throw new Error(`æ— æ•ˆURLæœªè¢«æ£€æµ‹: ${url}`);
                            }
                        } catch {
                            log('success', `âœ“ æ— æ•ˆURLè¢«æ­£ç¡®æ‹’ç»: ${url || '(ç©º)'}`);
                        }
                    }
                    
                    // æµ‹è¯•è¶…æ—¶æ—¶é—´éªŒè¯
                    const validTimeouts = [1000, 30000, 300000];
                    const invalidTimeouts = [500, 400000, -1000];
                    
                    for (const timeout of validTimeouts) {
                        if (timeout >= 1000 && timeout <= 300000) {
                            log('success', `âœ“ æœ‰æ•ˆè¶…æ—¶æ—¶é—´: ${timeout}ms`);
                        } else {
                            throw new Error(`è¶…æ—¶æ—¶é—´éªŒè¯å¤±è´¥: ${timeout}`);
                        }
                    }
                    
                    for (const timeout of invalidTimeouts) {
                        if (timeout < 1000 || timeout > 300000) {
                            log('success', `âœ“ æ— æ•ˆè¶…æ—¶æ—¶é—´è¢«æ­£ç¡®è¯†åˆ«: ${timeout}ms`);
                        } else {
                            throw new Error(`æ— æ•ˆè¶…æ—¶æ—¶é—´æœªè¢«æ£€æµ‹: ${timeout}`);
                        }
                    }
                    
                    return true;
                }
            },
            {
                id: 'error-handling-test',
                name: 'é”™è¯¯å¤„ç†æµ‹è¯•',
                async test() {
                    log('info', 'æµ‹è¯•é”™è¯¯å¤„ç†æœºåˆ¶...');
                    
                    // æµ‹è¯•ç½‘ç»œé”™è¯¯å¤„ç†
                    try {
                        const response = await fetch('http://invalid-url-that-does-not-exist.com', {
                            signal: AbortSignal.timeout(1000)
                        });
                    } catch (error) {
                        log('success', 'âœ“ ç½‘ç»œé”™è¯¯è¢«æ­£ç¡®æ•è·');
                    }
                    
                    // æµ‹è¯•JSONè§£æé”™è¯¯
                    try {
                        JSON.parse('invalid json');
                    } catch (error) {
                        log('success', 'âœ“ JSONè§£æé”™è¯¯è¢«æ­£ç¡®æ•è·');
                    }
                    
                    // æµ‹è¯•localStorageé”™è¯¯
                    const originalSetItem = Storage.prototype.setItem;
                    Storage.prototype.setItem = function() {
                        throw new Error('Storage quota exceeded');
                    };
                    
                    try {
                        localStorage.setItem('test', 'value');
                    } catch (error) {
                        log('success', 'âœ“ localStorageé”™è¯¯è¢«æ­£ç¡®å¤„ç†');
                    }
                    
                    // æ¢å¤åŸå§‹æ–¹æ³•
                    Storage.prototype.setItem = originalSetItem;
                    
                    return true;
                }
            }
        ];

        let testResults = {};

        function log(type, message) {
            const logArea = document.getElementById('log-area');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
        }

        async function runTest(testCase) {
            const resultDiv = document.getElementById(`test-${testCase.id}`);
            
            try {
                log('info', `å¼€å§‹æµ‹è¯•: ${testCase.name}`);
                resultDiv.className = 'test-item test-pending';
                resultDiv.querySelector('.status').textContent = 'è¿è¡Œä¸­';
                resultDiv.querySelector('.status').className = 'status status-pending';
                
                const result = await testCase.test();
                
                testResults[testCase.id] = { success: true, error: null };
                resultDiv.className = 'test-item test-pass';
                resultDiv.querySelector('.status').textContent = 'é€šè¿‡';
                resultDiv.querySelector('.status').className = 'status status-pass';
                log('success', `âœ… æµ‹è¯•é€šè¿‡: ${testCase.name}`);
                
            } catch (error) {
                testResults[testCase.id] = { success: false, error: error.message };
                resultDiv.className = 'test-item test-fail';
                resultDiv.querySelector('.status').textContent = 'å¤±è´¥';
                resultDiv.querySelector('.status').className = 'status status-fail';
                log('error', `âŒ æµ‹è¯•å¤±è´¥: ${testCase.name} - ${error.message}`);
            }
        }

        async function runAllTests() {
            log('info', 'ğŸš€ å¼€å§‹è¿è¡Œæ‰€æœ‰æµ‹è¯•...');
            testResults = {};
            
            for (const testCase of testCases) {
                await runTest(testCase);
                // æ·»åŠ å»¶è¿Ÿä»¥ä¾¿è§‚å¯Ÿ
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            // æ˜¾ç¤ºæµ‹è¯•æ‘˜è¦
            const totalTests = testCases.length;
            const passedTests = Object.values(testResults).filter(r => r.success).length;
            const failedTests = totalTests - passedTests;
            
            log('info', '=====================================');
            log('info', `æµ‹è¯•å®Œæˆï¼æ€»è®¡: ${totalTests} | é€šè¿‡: ${passedTests} | å¤±è´¥: ${failedTests}`);
            
            if (failedTests === 0) {
                log('success', 'ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼');
            } else {
                log('error', `âš ï¸ ${failedTests} ä¸ªæµ‹è¯•å¤±è´¥`);
            }
        }

        function clearResults() {
            document.getElementById('log-area').innerHTML = '';
            testResults = {};
            renderTestCases();
            log('info', 'æµ‹è¯•ç»“æœå·²æ¸…é™¤');
        }

        function openSettingsPage() {
            window.open('http://localhost:5173/settings/preferences', '_blank');
        }

        function renderTestCases() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            testCases.forEach(testCase => {
                const div = document.createElement('div');
                div.id = `test-${testCase.id}`;
                div.className = 'test-item';
                
                const result = testResults[testCase.id];
                let statusClass = '';
                let statusText = 'å¾…è¿è¡Œ';
                
                if (result) {
                    if (result.success) {
                        div.className += ' test-pass';
                        statusClass = 'status-pass';
                        statusText = 'é€šè¿‡';
                    } else {
                        div.className += ' test-fail';
                        statusClass = 'status-fail';
                        statusText = 'å¤±è´¥';
                    }
                }
                
                div.innerHTML = `
                    <strong>${testCase.name}</strong>
                    <span class="status ${statusClass}">${statusText}</span>
                    ${result && !result.success ? `<div style="color: red; font-size: 12px; margin-top: 5px;">${result.error}</div>` : ''}
                `;
                
                resultsDiv.appendChild(div);
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            renderTestCases();
            log('info', 'æµ‹è¯•ç¯å¢ƒå·²å‡†å¤‡å°±ç»ª');
            log('info', 'ç‚¹å‡»"è¿è¡Œæ‰€æœ‰æµ‹è¯•"æŒ‰é’®å¼€å§‹æµ‹è¯•');
        });
    </script>
</body>
</html>