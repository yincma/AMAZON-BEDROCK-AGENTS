<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PPTç”Ÿæˆæµ‹è¯• - è¯¦ç»†æ—¥å¿—åˆ†æ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 2px 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .log-info { color: #3794ff; }
        .log-success { color: #4ec9b0; }
        .log-warning { color: #ce9178; }
        .log-error { color: #f48771; }
        .log-debug { color: #b5cea8; }
        .btn {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn:hover {
            opacity: 0.9;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-running { background: #ffc107; color: #000; }
        .status-success { background: #28a745; color: white; }
        .status-error { background: #dc3545; color: white; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            text-align: center;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .metric-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        #networkTraffic {
            margin-top: 20px;
        }
        .request-item {
            padding: 10px;
            margin: 5px 0;
            border-left: 3px solid #007bff;
            background: #f8f9fa;
        }
        .request-success {
            border-left-color: #28a745;
        }
        .request-error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        .request-header {
            font-weight: bold;
            margin-bottom: 5px;
        }
        .request-details {
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” PPTç”Ÿæˆæµ‹è¯• - è¯¦ç»†æ—¥å¿—åˆ†æ</h1>

        <!-- æµ‹è¯•æ§åˆ¶ -->
        <div class="test-section">
            <h2>æµ‹è¯•æ§åˆ¶</h2>
            <div>
                <label>ä¸»é¢˜: <input type="text" id="topic" value="äººå·¥æ™ºèƒ½çš„å‘å±•è¶‹åŠ¿" style="width: 300px;"></label>
                <label>é¡µæ•°: <input type="number" id="pageCount" value="5" min="1" max="20" style="width: 60px;"></label>
            </div>
            <div style="margin-top: 10px;">
                <button class="btn btn-primary" onclick="startFullTest()">ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•</button>
                <button class="btn btn-success" onclick="testOptionsRequest()">ğŸ”§ æµ‹è¯•OPTIONSè¯·æ±‚</button>
                <button class="btn btn-danger" onclick="clearLogs()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
                <span id="testStatus" class="status-badge"></span>
            </div>
        </div>

        <!-- å®æ—¶æŒ‡æ ‡ -->
        <div class="test-section">
            <h2>å®æ—¶æŒ‡æ ‡</h2>
            <div class="metrics">
                <div class="metric-card">
                    <div class="metric-value" id="totalRequests">0</div>
                    <div class="metric-label">æ€»è¯·æ±‚æ•°</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="successRequests">0</div>
                    <div class="metric-label">æˆåŠŸè¯·æ±‚</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="failedRequests">0</div>
                    <div class="metric-label">å¤±è´¥è¯·æ±‚</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="avgResponseTime">0ms</div>
                    <div class="metric-label">å¹³å‡å“åº”æ—¶é—´</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="lastError">æ— </div>
                    <div class="metric-label">æœ€åé”™è¯¯</div>
                </div>
            </div>
        </div>

        <!-- ç½‘ç»œæµé‡ç›‘æ§ -->
        <div class="test-section">
            <h2>ç½‘ç»œæµé‡ç›‘æ§</h2>
            <div id="networkTraffic"></div>
        </div>

        <!-- è¯¦ç»†æ—¥å¿— -->
        <div class="test-section">
            <h2>è¯¦ç»†æ—¥å¿—</h2>
            <div class="log-container" id="logContainer"></div>
        </div>
    </div>

    <script>
        // é…ç½®
        const API_CONFIG = {
            endpoint: 'https://fe2kf91287.execute-api.us-east-1.amazonaws.com/dev',
            timeout: 30000
        };

        // ç»Ÿè®¡æ•°æ®
        let stats = {
            totalRequests: 0,
            successRequests: 0,
            failedRequests: 0,
            responseTimes: [],
            lastError: 'æ— '
        };

        // æ—¥å¿—å·¥å…·
        const Logger = {
            container: document.getElementById('logContainer'),

            log(message, type = 'info') {
                const timestamp = new Date().toISOString();
                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${timestamp}] ${message}`;
                this.container.appendChild(entry);
                this.container.scrollTop = this.container.scrollHeight;

                // åŒæ—¶è¾“å‡ºåˆ°æ§åˆ¶å°
                console.log(`[${type.toUpperCase()}] ${message}`);
            },

            info(message) { this.log(message, 'info'); },
            success(message) { this.log(message, 'success'); },
            warning(message) { this.log(message, 'warning'); },
            error(message) { this.log(message, 'error'); },
            debug(message) { this.log(message, 'debug'); }
        };

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            document.getElementById('totalRequests').textContent = stats.totalRequests;
            document.getElementById('successRequests').textContent = stats.successRequests;
            document.getElementById('failedRequests').textContent = stats.failedRequests;

            if (stats.responseTimes.length > 0) {
                const avg = stats.responseTimes.reduce((a, b) => a + b, 0) / stats.responseTimes.length;
                document.getElementById('avgResponseTime').textContent = `${Math.round(avg)}ms`;
            }

            document.getElementById('lastError').textContent = stats.lastError;
        }

        // æ·»åŠ ç½‘ç»œè¯·æ±‚è®°å½•
        function addNetworkRecord(method, url, status, duration, error = null) {
            const container = document.getElementById('networkTraffic');
            const item = document.createElement('div');
            item.className = `request-item ${error ? 'request-error' : 'request-success'}`;

            const header = document.createElement('div');
            header.className = 'request-header';
            header.textContent = `${method} ${url.replace(API_CONFIG.endpoint, '')} - ${status || 'FAILED'}`;

            const details = document.createElement('div');
            details.className = 'request-details';
            details.innerHTML = `
                Duration: ${duration}ms<br>
                Time: ${new Date().toLocaleTimeString()}<br>
                ${error ? `Error: ${error}` : 'Success'}
            `;

            item.appendChild(header);
            item.appendChild(details);
            container.insertBefore(item, container.firstChild);

            // åªä¿ç•™æœ€è¿‘20æ¡è®°å½•
            while (container.children.length > 20) {
                container.removeChild(container.lastChild);
            }
        }

        // æµ‹è¯•OPTIONSè¯·æ±‚
        async function testOptionsRequest() {
            Logger.info('=== å¼€å§‹OPTIONSé¢„æ£€è¯·æ±‚æµ‹è¯• ===');
            setTestStatus('running', 'æµ‹è¯•OPTIONSè¯·æ±‚...');

            const startTime = Date.now();
            stats.totalRequests++;

            try {
                const response = await fetch(`${API_CONFIG.endpoint}/generate`, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': window.location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });

                const duration = Date.now() - startTime;
                stats.responseTimes.push(duration);

                Logger.info(`OPTIONSå“åº”çŠ¶æ€: ${response.status}`);
                Logger.debug(`å“åº”æ—¶é—´: ${duration}ms`);

                // æ£€æŸ¥CORSå¤´
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers'),
                    'Access-Control-Max-Age': response.headers.get('Access-Control-Max-Age')
                };

                Logger.info('CORSå“åº”å¤´:');
                for (const [key, value] of Object.entries(corsHeaders)) {
                    if (value) {
                        Logger.success(`  ${key}: ${value}`);
                    } else {
                        Logger.warning(`  ${key}: æœªè®¾ç½®`);
                    }
                }

                if (response.ok) {
                    stats.successRequests++;
                    Logger.success('OPTIONSè¯·æ±‚æˆåŠŸ!');
                    addNetworkRecord('OPTIONS', `${API_CONFIG.endpoint}/generate`, response.status, duration);
                } else {
                    stats.failedRequests++;
                    stats.lastError = `OPTIONSå¤±è´¥: ${response.status}`;
                    Logger.error(`OPTIONSè¯·æ±‚å¤±è´¥: ${response.status}`);
                    addNetworkRecord('OPTIONS', `${API_CONFIG.endpoint}/generate`, response.status, duration, stats.lastError);
                }

            } catch (error) {
                stats.failedRequests++;
                stats.lastError = error.message;
                Logger.error(`OPTIONSè¯·æ±‚å¼‚å¸¸: ${error.message}`);
                Logger.error(`é”™è¯¯å †æ ˆ: ${error.stack}`);
                addNetworkRecord('OPTIONS', `${API_CONFIG.endpoint}/generate`, 0, Date.now() - startTime, error.message);
            }

            updateStats();
            setTestStatus('', '');
        }

        // æµ‹è¯•PPTç”Ÿæˆ
        async function testGenerateRequest() {
            Logger.info('=== å¼€å§‹PPTç”Ÿæˆè¯·æ±‚æµ‹è¯• ===');
            setTestStatus('running', 'ç”ŸæˆPPTä¸­...');

            const topic = document.getElementById('topic').value;
            const pageCount = parseInt(document.getElementById('pageCount').value);

            const requestBody = {
                topic: topic,
                page_count: pageCount,
                style: 'professional'
            };

            Logger.info(`è¯·æ±‚å‚æ•°: ${JSON.stringify(requestBody, null, 2)}`);

            const startTime = Date.now();
            stats.totalRequests++;

            try {
                Logger.debug('å‘é€POSTè¯·æ±‚...');
                const response = await fetch(`${API_CONFIG.endpoint}/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody),
                    mode: 'cors'
                });

                const duration = Date.now() - startTime;
                stats.responseTimes.push(duration);

                Logger.info(`å“åº”çŠ¶æ€: ${response.status}`);
                Logger.debug(`å“åº”æ—¶é—´: ${duration}ms`);

                // æ£€æŸ¥å“åº”å¤´
                Logger.debug('å“åº”å¤´:');
                for (const [key, value] of response.headers.entries()) {
                    Logger.debug(`  ${key}: ${value}`);
                }

                if (response.ok) {
                    const data = await response.json();
                    Logger.success('PPTç”Ÿæˆè¯·æ±‚æˆåŠŸ!');
                    Logger.info(`å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`);
                    stats.successRequests++;
                    addNetworkRecord('POST', `${API_CONFIG.endpoint}/generate`, response.status, duration);

                    // å¦‚æœæ˜¯å¼‚æ­¥æ¨¡å¼ï¼Œè¿”å›äº†presentation_id
                    if (data.presentation_id && data.status === 'processing') {
                        Logger.info('æ£€æµ‹åˆ°å¼‚æ­¥æ¨¡å¼ï¼Œå¼€å§‹è½®è¯¢çŠ¶æ€...');
                        await pollStatus(data.presentation_id);
                    }
                } else {
                    const errorText = await response.text();
                    stats.failedRequests++;
                    stats.lastError = `ç”Ÿæˆå¤±è´¥: ${response.status}`;
                    Logger.error(`PPTç”Ÿæˆå¤±è´¥: ${response.status}`);
                    Logger.error(`é”™è¯¯å“åº”: ${errorText}`);
                    addNetworkRecord('POST', `${API_CONFIG.endpoint}/generate`, response.status, duration, errorText);
                }

            } catch (error) {
                stats.failedRequests++;
                stats.lastError = error.message;
                Logger.error(`ç”Ÿæˆè¯·æ±‚å¼‚å¸¸: ${error.message}`);
                Logger.error(`é”™è¯¯ç±»å‹: ${error.name}`);
                Logger.error(`é”™è¯¯å †æ ˆ: ${error.stack}`);

                // è¯¦ç»†çš„CORSé”™è¯¯åˆ†æ
                if (error.message.includes('CORS') || error.message.includes('Failed to fetch')) {
                    Logger.error('ğŸš¨ CORSé”™è¯¯æ£€æµ‹!');
                    Logger.error('å¯èƒ½çš„åŸå› :');
                    Logger.error('1. API Gatewayæœªæ­£ç¡®é…ç½®CORS');
                    Logger.error('2. Lambdaå‡½æ•°æœªè¿”å›CORSå¤´');
                    Logger.error('3. è¯·æ±‚è¶…æ—¶æˆ–ç½‘ç»œé”™è¯¯');
                }

                addNetworkRecord('POST', `${API_CONFIG.endpoint}/generate`, 0, Date.now() - startTime, error.message);
            }

            updateStats();
            setTestStatus('', '');
        }

        // è½®è¯¢çŠ¶æ€
        async function pollStatus(presentationId, maxAttempts = 30) {
            Logger.info(`å¼€å§‹è½®è¯¢çŠ¶æ€: ${presentationId}`);
            let attempts = 0;

            while (attempts < maxAttempts) {
                attempts++;
                Logger.debug(`è½®è¯¢å°è¯• ${attempts}/${maxAttempts}`);

                const startTime = Date.now();
                stats.totalRequests++;

                try {
                    const response = await fetch(`${API_CONFIG.endpoint}/status/${presentationId}`, {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    const duration = Date.now() - startTime;
                    stats.responseTimes.push(duration);

                    if (response.ok) {
                        const data = await response.json();
                        Logger.info(`çŠ¶æ€: ${data.status}, è¿›åº¦: ${data.progress}%`);
                        stats.successRequests++;
                        addNetworkRecord('GET', `${API_CONFIG.endpoint}/status/${presentationId}`, response.status, duration);

                        if (data.status === 'completed') {
                            Logger.success('PPTç”Ÿæˆå®Œæˆ!');
                            Logger.info(`ä¸‹è½½é“¾æ¥: ${data.download_url}`);
                            break;
                        } else if (data.status === 'failed') {
                            Logger.error('PPTç”Ÿæˆå¤±è´¥!');
                            Logger.error(`é”™è¯¯ä¿¡æ¯: ${data.error}`);
                            break;
                        }
                    } else {
                        stats.failedRequests++;
                        Logger.error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${response.status}`);
                        addNetworkRecord('GET', `${API_CONFIG.endpoint}/status/${presentationId}`, response.status, duration, `Status ${response.status}`);
                    }
                } catch (error) {
                    stats.failedRequests++;
                    Logger.error(`çŠ¶æ€æŸ¥è¯¢å¼‚å¸¸: ${error.message}`);
                    addNetworkRecord('GET', `${API_CONFIG.endpoint}/status/${presentationId}`, 0, Date.now() - startTime, error.message);
                }

                // ç­‰å¾…2ç§’åé‡è¯•
                await new Promise(resolve => setTimeout(resolve, 2000));
            }

            updateStats();
        }

        // å®Œæ•´æµ‹è¯•
        async function startFullTest() {
            clearLogs();
            Logger.info('ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•æµç¨‹');
            Logger.info(`APIç«¯ç‚¹: ${API_CONFIG.endpoint}`);
            Logger.info(`å½“å‰æº: ${window.location.origin}`);

            // å…ˆæµ‹è¯•OPTIONS
            await testOptionsRequest();

            // ç­‰å¾…1ç§’
            await new Promise(resolve => setTimeout(resolve, 1000));

            // æµ‹è¯•ç”Ÿæˆè¯·æ±‚
            await testGenerateRequest();

            Logger.info('âœ… æµ‹è¯•æµç¨‹å®Œæˆ');
            Logger.info(`æ€»ç»“: æ€»è¯·æ±‚${stats.totalRequests}, æˆåŠŸ${stats.successRequests}, å¤±è´¥${stats.failedRequests}`);
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('networkTraffic').innerHTML = '';
            stats = {
                totalRequests: 0,
                successRequests: 0,
                failedRequests: 0,
                responseTimes: [],
                lastError: 'æ— '
            };
            updateStats();
            Logger.info('æ—¥å¿—å·²æ¸…é™¤');
        }

        // è®¾ç½®æµ‹è¯•çŠ¶æ€
        function setTestStatus(status, text) {
            const badge = document.getElementById('testStatus');
            if (status) {
                badge.className = `status-badge status-${status}`;
                badge.textContent = text;
            } else {
                badge.className = 'status-badge';
                badge.textContent = '';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('load', () => {
            Logger.info('æµ‹è¯•é¡µé¢å·²åŠ è½½');
            Logger.info(`æµè§ˆå™¨: ${navigator.userAgent}`);
            updateStats();
        });

        // æ•è·å…¨å±€é”™è¯¯
        window.addEventListener('error', (event) => {
            Logger.error(`å…¨å±€é”™è¯¯: ${event.message}`);
            Logger.error(`æ–‡ä»¶: ${event.filename}, è¡Œ: ${event.lineno}, åˆ—: ${event.colno}`);
        });

        // æ•è·æœªå¤„ç†çš„Promise rejection
        window.addEventListener('unhandledrejection', (event) => {
            Logger.error(`æœªå¤„ç†çš„Promise rejection: ${event.reason}`);
        });
    </script>
</body>
</html>